name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Install HDF5
        run: sudo apt-get update && sudo apt-get install -y libhdf5-dev

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Cargo check (server + shared)
        run: cargo check -p server -p shared

      - name: Cargo check (client)
        run: |
          rustup target add wasm32-unknown-unknown
          cargo check -p client --target wasm32-unknown-unknown

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: check
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
